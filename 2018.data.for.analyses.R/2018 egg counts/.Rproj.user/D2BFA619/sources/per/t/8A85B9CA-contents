##
#11/9/17
#looked at the proportions fo fish recollected from each treatment
#suggests that lethal predation was not driving changes in reproductive output

#clear workspace
rm(list=ls())

library(lme4)
#install.packages("lmerTest")
library(lmerTest)
#neg.binom
library(MASS)

#three differnt datasets
#gobydata<-read.csv("Data/egg_counts_raw_data_10_29_17.csv")
goby.den.survey<-read.csv("Data/density_surveys_11_13_17_R..csv")
goby.den.complete<-read.csv("Data/recollections_visual_surveys_11_9_17_trial_3_only.csv")

#make sure that all necessary variables are stored as factors
goby.den.survey$Trial<-as.factor(goby.den.survey$Trial)
goby.den.survey$Day<-as.factor(goby.den.survey$Day)
goby.den.survey$Position<-as.factor(goby.den.survey$Position)
goby.den.survey$Hours_after_deploy<-as.factor(goby.den.survey$Hours_after_deploy)
goby.den.survey$Days_after_deploy<-as.factor(goby.den.survey$Days_after_deploy)
#goby.den.survey$Proportion_pop<-as.integer(goby.den.survey$Days_after_deploy)

goby.den.survey$Proportion_pop

#subset the data to just get survey data from day 6
goby.den.survey<-subset(goby.den.survey, Days_after_deploy=="6")
goby.den.survey

#try with all trials first, might have to go with a different distribution
#goby.grav.prop<-subset(goby.grav.prop, Trial=="3")
hist(goby.den.survey$Density)

mod1.den<-lm(Density~Treatment,data=goby.den.survey)
mod2.den<-lmer(Density~Treatment+(1|Position),data=goby.den.survey)
mod3.den<-lmer(Density~Treatment+(1|Position)+(1|Trial),data=goby.den.survey)
mod4.den.poiss<-glmer(Density~Treatment+(1|Position)+(1|Trial), family=poisson,data=goby.den.survey)

#normality of resids
hist(resid(mod1.den))
hist(resid(mod2.den))
hist(resid(mod3.den))
hist(resid(mod4.den.poiss))

qqnorm(resid(mod1.den))
qqline(resid(mod1.den))

anova(mod2.den,mod3.den,mod4.den.poiss)
AIC(mod1.den)

ranef(mod3.prop)
#it seems like recolelctions were pretty variable by trial
#most in trial 3, then trial 2, then trial 1

#fixef(mod3.prop)

anova(mod1.den)
#no effect of treatment? Might have to go run the same test I did with original egg counts

#looking at the effects of treatment on just gravid females
bargraph.CI(x.factor = Treatment, response = Proportion_all_recollected, main="Prop. all recollected", data = goby.grav.prop)

#no sig. difference in number of gravids recollected on each reef

bargraph.CI(x.factor = Treatment, response = Proportion_all_recollected, main="Prop. all recollected", data = goby.grav.prop)

#no sig difference in # of total fish recollected based on treatment

#suggests that lethal predation was not a factor

interaction.plot(goby.den.survey$Hours_after_deploy, goby.den.survey$Treatment, goby.den.survey$Density, fun = mean)


##changed the density data to proportional data
hist(goby.den.survey$Proportion_pop)

mod1.den.prop<-lm(Proportion_pop~Treatment,data=goby.den.survey)
mod2.den.prop<-lmer(Proportion_pop~Treatment+(1|Position),data=goby.den.survey)
mod3.den.prop<-lmer(Proportion_pop~Treatment+(1|Position)+(1|Trial),data=goby.den.survey)
mod4.den.prop.gamma<-glmer(Proportion_pop~Treatment+(1|Position)+(1|Trial), family=Gamma(link="log"),data=goby.den.survey)
#can't do poiss with cont. data

#going to get a sense of the mean proportions seen
prop.means<-tapply(goby.den.survey$Proportion_pop, goby.den.survey$Treatment,mean)
prop.means

#normality of resids
hist(resid(mod1.den.prop))
hist(resid(mod2.den.prop))
hist(resid(mod3.den.prop))
hist(resid(mod4.den.prop.gamma))#best model based on AIC value, even though the data look non-normal

#qqnorm(resid(mod1.den))
#qqline(resid(mod1.den))

anova(mod2.den.prop,mod3.den.prop,mod4.den.prop.gamma)
AIC(mod1.den.prop)

plot(mod4.den.prop.gamma)
plot(mod3.den.prop)
plot(mod2.den.prop)
plot(mod1.den.prop)

#ranef(mod3.prop)
#it seems like recolelctions were pretty variable by trial
#most in trial 3, then trial 2, then trial 1

#fixef(mod3.prop)

anova(mod4.den.prop.gamma)
summary(mod4.den.prop.gamma)
fixef(mod4.den.prop.gamma)
#no effect of treatment? Might have to go run the same test I did with original egg counts

#going to use same snalyses for this model that I used for egg counts
library(car)
Anova(mod4.den.prop.gamma, type="III")

#sciplot
library(sciplot)

#looking at the effects of treatment on just gravid females
bargraph.CI(x.factor = Hours_after_deploy, response = Proportion_pop, group = Treatment, main="Prop. pop. seen over time", data = goby.den.survey)

lineplot.CI(Hours_after_deploy,Proportion_pop,group=Treatment, data=goby.den.survey)

#seems like high treatment decreased initially, then stayed low

#interaction.plot(goby.den.survey$Hours_after_deploy, goby.den.survey$Treatment, goby.den.survey$Density, fun = mean)

interaction.plot(goby.den.survey$Hours_after_deploy, goby.den.survey$Treatment, goby.den.survey$Proportion_pop, main= "Goby visual density surveys (all trials)", xlab = "Hours after deployment", ylab = "Proportion fish observed", fun = mean)

#want to try out ggplot and see what it says
#this is a bit unique, because I want to use two datasets (the goby.den.survey and the goby recollection data)
#have already subset my survey data to only day 6 surveys
library(ggplot2)

tcbri.1<-(with(goby.den.survey, aggregate((Proportion_pop), list(Treatment=Treatment), mean)))
#now apply the se function to the 4th column [,3]
tcbri.1$se<-with(goby.den.survey, aggregate((Proportion_pop), list(Treatment=Treatment), function(x) sd(x)/sqrt(length(x))))[,2]
tcbri.1

#ggplot with facet_grid function
#can force ggplot to change the x-axis label orders, just have to put 
#"scale_x_discrete..." code before the "facet code"
library(ggplot2)


#code for combining two datasets
(plot2 <- ggplot(NULL, aes(v, p)) + 
    geom_point(data = df1) +
    geom_step(data = df2))

#this is for all of the data
#geom_linerange = no caps on error bars
#theme_clasic() = no grid in background

doom<- ggplot(tcbri.1, aes(x=Treatment, y=x)) +
  geom_bar(stat="identity", colour="black",position="dodge")+ 
  scale_x_discrete(limits=c("Low","Medium","High"))+
  theme_classic()  
doom + geom_linerange(aes(ymin=x-se, ymax=x+se), size=0.5,   
                     position=position_dodge(.9)) + theme(text = element_text(size = 14)) +
  labs(x="Risk Treatment", y="Proportion of fish observed Day 6")

#####----now looking at day 7 recollections, might be able to combine plots, but not sure how to analyze...

tcbri.d7<-(with(goby.grav.prop, aggregate((Proportion_all_recollected), list(Treatment=Treatment), mean)))
#now apply the se function to the 4th column [,3]
tcbri.d7$se<-with(goby.grav.prop, aggregate((Proportion_all_recollected), list(Treatment=Treatment), function(x) sd(x)/sqrt(length(x))))[,2]
tcbri.d7

doom<- ggplot(tcbri.d7, aes(x=Treatment, y=x)) +
  geom_bar(stat="identity", colour="black",position="dodge")+ 
  scale_x_discrete(limits=c("Low","Medium","High"))+ geom_bar()
  theme_classic()  
doom + geom_linerange(aes(ymin=x-se, ymax=x+se), size=0.5,   
                      position=position_dodge(.9)) + theme(text = element_text(size = 14)) +
  labs(x="Risk Treatment", y="Proportion of fish recollected")

plot2 <- ggplot(NULL, aes(x=Treatment, y=x)) + 
    geom_bar(data = tcbri.1, stat="identity", colour="black",position="dodge")+ 
  scale_x_discrete(limits=c("Low","Medium","High"))+ geom_bar()
theme_classic()  
doom + geom_linerange(aes(ymin=x-se, ymax=x+se), size=0.5,   
                      position=position_dodge(.9)) + theme(text = element_text(size = 14)) +
  labs(x="Risk Treatment", y="Proportion of fish recollected") +
    geom_bar(data = tcbri.d7, stat="identity", colour="black",position="dodge")+ 
  scale_x_discrete(limits=c("Low","Medium","High"))+ geom_bar()
theme_classic()  
doom + geom_linerange(aes(ymin=x-se, ymax=x+se), size=0.5,   
                      position=position_dodge(.9)) + theme(text = element_text(size = 14)) +
  labs(x="Risk Treatment", y="Proportion of fish recollected")

##didnt work initially
newplot<-ggplot() + 
  geom_bar(data=tcbri.d7, aes(x=Treatment, y=x), color='red') + 
  geom_bar(data=tcbri.1, aes(x=Treatment, y=x), color='blue') + 
  scale_x_discrete(limits=c("Low","Medium","High"))+
  theme_classic()  
doom + geom_linerange(aes(ymin=x-se, ymax=x+se), size=0.5,   
                      position=position_dodge(.9)) + theme(text = element_text(size = 14)) +
  labs(x="Risk Treatment", y="Proportion of fish observed Day 6")

(plot2 <- ggplot(NULL, aes(v, p)) + 
    geom_point(data = df1) +
    geom_step(data = df2))

#think about making the dataframe into one frame for ggplot. A way to do that would be to have the 
#data into one excel sheet

#now that I have them in one dataframe, I think I can look a them together

goby.den.complete<-read.csv("Data/recollections_visual_surveys_11_9_17_trial_3_only.csv")

#make sure that all necessary variables are stored as factors
goby.den.complete$Trial<-as.factor(goby.den.complete$Trial)
goby.den.complete$Day<-as.factor(goby.den.complete$Day)
goby.den.complete$Position<-as.factor(goby.den.complete$Position)
goby.den.complete$Hours_after_deploy<-as.factor(goby.den.complete$Hours_after_deploy)
goby.den.complete$Days_after_deploy<-as.factor(goby.den.complete$Days_after_deploy)

#subset the data to just get survey data from day 6
#goby.den.survey<-subset(goby.den.survey, Days_after_deploy=="6")
#goby.den.survey

#try with all trials first, might have to go with a different distribution
#goby.grav.prop<-subset(goby.grav.prop, Trial=="3")
hist(goby.den.complete$Density)

mod1.den<-lm(Density~Treatment,data=goby.den.complete)
mod2.den<-lmer(Density~Treatment+(1|Position),data=goby.den.complete)
mod3.den<-lmer(Density~Treatment+(1|Position),data=goby.den.complete)
mod4.den.gamma<-glmer(Density~Treatment+(1|Position), family=Gamma(link="log"),data=goby.den.complete)

#normality of resids
hist(resid(mod1.den))
hist(resid(mod2.den))
hist(resid(mod3.den))
hist(resid(mod4.den.gamma))

qqnorm(resid(mod1.den))
qqline(resid(mod1.den))

anova(mod2.den,mod3.den,mod4.den.gamma)
AIC(mod1.den)

ranef(mod3.prop)
#it seems like recolelctions were pretty variable by trial
#most in trial 3, then trial 2, then trial 1

tc<-with(goby.den.complete, aggregate((Proportion), list(Density_method=Density_method,Treatment=Treatment), mean))
tc$se<-with(goby.den.complete, aggregate((Proportion), list(Density_method=Density_method,Treatment=Treatment), function(x) sd(x)/length(x)))[,3]
detach(Time_budget_HASE)
detach(Time_budget_HASE)
attach(tc)
##now that I have the means and sem in the same data frame I can plug all of that into ggplot
tc

ggplot(tc, aes(Treatment,y=x,fill=Density_method)+ ##really important that the formula matches the columns in the data frame
  geom_bar(stat="identity", position="dodge")+
  geom_linerange(aes(ymax=x+se, ymin=x-se), stat="identity", position=position_dodge(width = 0.9), width=0.1)+
  labs(x="Risk Treatment", y="Number of fish observed per reef") +
  theme_classic() + theme(panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank(),
                     axis.line=element_line(colour="black"))+
                     scale_x_discrete(limits=c("Low","Medium","High")))

#grrr.
doom<- ggplot(tc, aes(x=Treatment, y=x)) +
  geom_bar(stat="identity", colour="black",position="dodge")+ 
  scale_x_discrete(limits=c("Low","Medium","High"))+
  facet_grid(~Density_method) + theme_bw() +
  theme_classic()  
doom + geom_linerange(aes(ymin=x-se, ymax=x+se), size=0.5,   
                      position=position_dodge(.9)) + theme(text = element_text(size = 14)) +
  facet_grid(~Density_method) +
  labs(x="Risk Treatment", y="Proportion of fish observed Day 6")

##
doom.d7<- ggplot(tcbri.d7, aes(x=Treatment, y=x)) +
  geom_bar(stat="identity", colour="black",position="dodge")+ 
  scale_x_discrete(limits=c("Low","Medium","High"))
#facet_grid(~Day) + theme_bw()  
doom.d7 + geom_errorbar(aes(ymin=x-se, ymax=x+se), size=0.5,   
                        width=.25,position=position_dodge(.9)) + theme(text = element_text(size = 14)) +
  
  labs(x="Risk Treatment", y="Average Reproduction (# eggs per gravid female)")
#dev.off()

